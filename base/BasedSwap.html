<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Based Swap by zAMM</title>
    <link
      rel="icon"
      href="https://content.wrappr.wtf/ipfs/bafybeibuct6mftnmgzkbn4tq47elpokbkahkjxq7z6qceptlcsvpxletou"
      sizes="any"
    />
    <link
      rel="apple-touch-icon"
      href="https://content.wrappr.wtf/ipfs/bafybeibuct6mftnmgzkbn4tq47elpokbkahkjxq7z6qceptlcsvpxletou"
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.15.0/ethers.umd.min.js"
      integrity="sha512-UXYETj+vXKSURF1UlgVRLzWRS9ZiQTv3lcL4rbeLyqTXCPNZC6PTLF/Ik3uxm2Zo+E109cUpJPZfLxJsCgKSng=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, sans-serif;
        background-color: #0a0a0f;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 1920 1080' preserveAspectRatio='xMidYMid slice' xmlns='http://www.w3.org/2000/svg'%3E %3Cdefs%3E %3ClinearGradient id='mainGradient' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E %3Cstop offset='0%25' style='stop-color:%230a0a0f;stop-opacity:1' /%3E %3Cstop offset='25%25' style='stop-color:%230f0f1a;stop-opacity:1' /%3E %3Cstop offset='50%25' style='stop-color:%230a0a12;stop-opacity:1' /%3E %3Cstop offset='75%25' style='stop-color:%230d0d18;stop-opacity:1' /%3E %3Cstop offset='100%25' style='stop-color:%23060609;stop-opacity:1' /%3E %3C/linearGradient%3E %3Cpattern id='zPattern' x='0' y='0' width='120' height='120' patternUnits='userSpaceOnUse'%3E %3Cpath d='M 20 30 L 60 30 L 20 60 L 60 60' fill='none' stroke='%23627eea' stroke-width='2' stroke-linecap='square' opacity='0.15'/%3E %3Cpath d='M 70 70 L 100 70 L 70 90 L 100 90' fill='none' stroke='%234a65d6' stroke-width='1.5' stroke-linecap='square' opacity='0.1'/%3E %3C/pattern%3E %3Cpattern id='bigZPattern' x='0' y='0' width='400' height='400' patternUnits='userSpaceOnUse'%3E %3Cpath d='M 50 100 L 350 100 L 50 300 L 350 300' fill='none' stroke='%23627eea' stroke-width='3' stroke-linecap='square' opacity='0.08'/%3E %3C/pattern%3E %3ClinearGradient id='zGradient' x1='0%25' y1='0%25' x2='100%25' y2='0%25'%3E %3Cstop offset='0%25' style='stop-color:%23627eea;stop-opacity:0.2' /%3E %3Cstop offset='50%25' style='stop-color:%238a9fff;stop-opacity:0.3' /%3E %3Cstop offset='100%25' style='stop-color:%23627eea;stop-opacity:0.2' /%3E %3C/linearGradient%3E %3CradialGradient id='vignette'%3E %3Cstop offset='50%25' style='stop-color:%23000000;stop-opacity:0' /%3E %3Cstop offset='100%25' style='stop-color:%23000000;stop-opacity:0.3' /%3E %3C/radialGradient%3E %3ClinearGradient id='lightSweep' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E %3Cstop offset='0%25' style='stop-color:%23ffffff;stop-opacity:0' /%3E %3Cstop offset='45%25' style='stop-color:%23ffffff;stop-opacity:0' /%3E %3Cstop offset='50%25' style='stop-color:%23ffffff;stop-opacity:0.03' /%3E %3Cstop offset='55%25' style='stop-color:%23ffffff;stop-opacity:0' /%3E %3Cstop offset='100%25' style='stop-color:%23ffffff;stop-opacity:0' /%3E %3C/linearGradient%3E %3C/defs%3E %3Crect width='100%25' height='100%25' fill='url(%23mainGradient)'/%3E %3Crect width='100%25' height='100%25' fill='url(%23bigZPattern)' opacity='0.5'/%3E %3Crect width='100%25' height='100%25' fill='url(%23zPattern)'/%3E %3Crect width='100%25' height='100%25' fill='url(%23zPattern)' transform='rotate(-15 960 540)' opacity='0.7'/%3E %3Crect width='100%25' height='100%25' fill='url(%23lightSweep)'/%3E %3Crect width='100%25' height='100%25' fill='url(%23vignette)'/%3E%3C/svg%3E");
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }
      .container {
        background: #f9f9f9;
        border-radius: 16px;
        padding: 32px;
        width: 100%;
        max-width: 420px;
        position: relative;
      }
      .logo-gif {
        position: absolute;
        top: 24px;
        right: 24px;
        width: 32px;
        height: 32px;
      }
      h1 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 24px;
        color: #000;
      }
      .wallet-section {
        margin-bottom: 24px;
        text-align: center;
      }
      .connect-btn {
        background: #000;
        color: #fff;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        width: 100%;
      }
      .connect-btn:hover {
        background: #333;
      }
      .connected {
        background: #000;
      }
      .token-input {
        border: 2px solid #000;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
      }
      .token-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .token-select {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #f9f9f9;
        border: 2px solid #000;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .token-select:hover {
        background: #e0e0e0;
      }
      .token-icon {
        width: 24px;
        height: 24px;
      }
      .token-symbol {
        font-weight: 600;
        color: #000;
      }
      .amount-input {
        width: 100%;
        background: transparent;
        border: none;
        font-size: 28px;
        font-weight: 500;
        outline: none;
        color: #000;
      }
      .amount-input::placeholder {
        color: #999;
      }
      .slip-inline {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .slip-unit {
        color: #4b5563;
        font-weight: 600;
      }
      .slip-inline {
        cursor: text;
      }
      .slip-unit {
        pointer-events: none;
      }
      .slip-num {
        -webkit-appearance: none;
        appearance: textfield;
        background: transparent;
        border: 0;
        border-bottom: 2px solid rgba(0, 0, 0, 0.25);
        border-radius: 0;
        padding: 2px 0;
        width: 4.5ch;
        min-width: 3.5ch;
        text-align: right;
        font-size: 14px;
        color: #0f172a;
        outline: none;
        transition: border-color 0.15s ease, color 0.15s ease;
      }
      .slip-num:hover {
        border-bottom-color: rgba(0, 0, 0, 0.45);
      }
      .slip-num:focus {
        border-bottom-color: #000;
      }
      .slip-num::-webkit-outer-spin-button,
      .slip-num::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .slip-num[type="number"] {
        -moz-appearance: textfield;
      }
      @media (prefers-color-scheme: dark) {
        .slip-unit {
          color: #cbd5e1;
        }
        .slip-num {
          color: #e5e7eb;
          border-bottom-color: rgba(255, 255, 255, 0.35);
        }
        .slip-num:hover {
          border-bottom-color: rgba(255, 255, 255, 0.55);
        }
        .slip-num:focus {
          border-bottom-color: #fff;
        }
      }
      .balance {
        font-size: 14px;
        color: #666;
        margin-top: 8px;
      }
      .swap-arrow {
        display: flex;
        justify-content: center;
        margin: -6px 0;
        z-index: 1;
        position: relative;
      }
      .arrow-btn {
        background: #f9f9f9;
        border: 2px solid #000;
        border-radius: 8px;
        padding: 8px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .arrow-btn:hover {
        transform: rotate(180deg);
        background: #e0e0e0;
      }
      .swap-btn {
        background: #000;
        color: #fff;
        border: none;
        padding: 16px;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        margin-top: 24px;
        transition: all 0.2s;
      }
      .swap-btn:hover:not(:disabled) {
        background: #333;
      }
      .swap-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .token-actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .token-subactions {
        display: flex;
        justify-content: flex-end;
        margin: 6px 0;
      }
      .max-btn {
        padding: 4px 10px;
        border: 2px solid #000;
        background: #fff;
        color: #000;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.02em;
        cursor: pointer;
        transition: all 0.2s;
      }
      .max-btn:hover {
        background: #000;
        color: #fff;
      }
      .max-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .quote-info {
        border: 1px solid #000;
        border-radius: 8px;
        padding: 12px;
        margin-top: 16px;
        font-size: 14px;
        color: #000;
        overflow: hidden;
      }
      .quote-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .quote-row > :nth-child(2) {
        margin-left: auto;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-align: right;
      }
      #routeInfo {
        max-width: 65%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      #routeInfo[data-size="sm"] {
        font-size: 13px;
      }
      #routeInfo[data-size="xs"] {
        font-size: 12px;
      }
      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #ccc;
        border-top: 2px solid #000;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .custom-token-input {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid #000;
        border-radius: 6px;
        margin-top: 8px;
        font-size: 14px;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #000;
      }
      .token-list-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .token-list-item:hover {
        background: #f0f0f0;
      }
      .page-stack {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }
      .attribution {
        text-align: center;
        font-size: 12px;
        color: #ffffff;
      }
      .attribution a {
        color: #ffffff;
        text-decoration: none;
        border-bottom: 1px dotted rgba(255, 255, 255, 0.4);
      }
      .attribution a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="page-stack">
      <div class="container">
        <h1>Based Swap</h1>


        <div class="branding">
          <img
            src="https://content.wrappr.wtf/ipfs/bafkreifquimjbbzmuktrsugeqdkzp26cxmpcfcvoufwy6oyruhxs7kpa7u"
            alt="Based"
            class="logo-gif"
          />
        </div>


        <div class="wallet-section">
          <button id="connectBtn" class="connect-btn">Connect Wallet</button>
        </div>


        <div class="token-input">
          <div class="token-header">
            <span style="color: #718096; font-size: 14px">From</span>
            <div class="token-select" onclick="openTokenModal('from')">
              <span id="fromTokenIcon" class="token-icon"></span>
              <span id="fromTokenSymbol" class="token-symbol">ETH</span>
            </div>
          </div>
          <div class="token-subactions">
            <button class="max-btn" type="button" onclick="setMaxFromBalance()">
              MAX
            </button>
          </div>
          <input
            type="number"
            id="fromAmount"
            class="amount-input"
            placeholder="0.0"
            step="any"
          />
          <div id="fromBalance" class="balance">Balance: --</div>
        </div>


        <div class="swap-arrow">
          <button class="arrow-btn" onclick="swapTokens()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="#000"
              stroke-width="2"
            >
              <path d="M7 10L12 15L17 10" />
            </svg>
          </button>
        </div>


        <div class="token-input">
          <div class="token-header">
            <span style="color: #718096; font-size: 14px">To</span>
            <div class="token-select" onclick="openTokenModal('to')">
              <span id="toTokenIcon" class="token-icon"></span>
              <span id="toTokenSymbol" class="token-symbol">USDC</span>
            </div>
          </div>
          <input
            type="number"
            id="toAmount"
            class="amount-input"
            placeholder="0.0"
            readonly
          />
          <div id="toBalance" class="balance">Balance: --</div>
        </div>


        <div id="quoteInfo" class="quote-info" style="display: none">
          <div class="quote-row">
            <span>Route:</span><span id="routeInfo">--</span>
          </div>
          <div class="quote-row">
            <span>Slippage:</span>
            <span class="slip-inline">
              <input
                id="slippagePct"
                class="slip-num"
                type="number"
                inputmode="decimal"
                min="0"
                max="20"
                step="0.1"
                value="0.5"
                aria-label="Slippage (%)"
              />
              <span class="slip-unit">%</span>
            </span>
          </div>
        </div>


        <button id="swapBtn" class="swap-btn" disabled>Connect Wallet</button>
      </div>
      <div class="attribution">
        <a
          href="https://github.com/zammdefi/zRouter"
          target="_blank"
          rel="noopener noreferrer"
          >zRouter</a
        >
        by
        <a
          href="https://zamm.finance/"
          target="_blank"
          rel="noopener noreferrer"
          >zamm.finance</a
        >
        by
        <a
          href="https://x.com/z0r0zzz"
          target="_blank"
          rel="noopener noreferrer"
          >z0r0z</a
        >
      </div>
      <div class="attribution" style="font-style: italic; margin-top: 6px">
        100% onchain DEX solver. No fees. Best rates from Uniswap, Aerodrome &
        zAMM. Calldata compressed to save 50% on gas.
      </div>
    </div>


    <div id="tokenModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Select Token</h3>
          <button class="close-btn" onclick="closeTokenModal()">&times;</button>
        </div>
        <div id="tokenList"></div>
        <input
          type="text"
          id="customTokenAddress"
          class="custom-token-input"
          placeholder="Enter token address"
        />
        <button
          class="connect-btn"
          style="margin-top: 12px"
          onclick="addCustomToken()"
        >
          Add Custom Token
        </button>
      </div>
    </div>


    <script>
      const CHAIN_ID = 8453; // Base
      const ZQUOTER_ADDRESS = "0x772E2810A471dB2CC7ADA0d37D6395476535889a";
      const ZROUTER_ADDRESS = "0x0000000000404FECAf36E6184245475eE1254835";
      const USDC_ADDRESS = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";
      const USDT_ADDRESS = "0xfde4C96c8593536E31F229EA8f37b2ADa2699bb2";
      const CBBTC_ADDRESS = "0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf";
      const WSTETH_ADDRESS = "0xc1CBa3fCea344f92D9239c08C0568f6F2F0ee452";
      const ZORA_ADDRESS = "0x1111111111166b7FE7bd91427724B487980aFc69";
      const ZERO_ADDRESS = "0x0000000000000000000000000000000000000000";


      let provider, signer, account;
      let currentModal = null;
      const tokens = {
        ETH: { address: ZERO_ADDRESS, symbol: "ETH", decimals: 18 },
        USDC: { address: USDC_ADDRESS, symbol: "USDC", decimals: 6 },
        USDT: { address: USDT_ADDRESS, symbol: "USDT", decimals: 6 },
        cbBTC: { address: CBBTC_ADDRESS, symbol: "cbBTC", decimals: 8 },
        wstETH: { address: WSTETH_ADDRESS, symbol: "wstETH", decimals: 18 },
        ZORA: { address: ZORA_ADDRESS, symbol: "ZORA", decimals: 18 },
      };


      let fromToken = "ETH";
      let toToken = "USDC";


      let slippageBps = 50; // default 0.5%


      // Icons
      const ETH_ICON = `<svg fill="#000000" width="24" height="24" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><g fill-rule="evenodd"><path d="M16 32C7.163 32 0 24.837 0 16S7.163 0 16 0s16 7.163 16 16-7.163 16-16 16zm7.994-15.781L16.498 4 9 16.22l7.498 4.353 7.496-4.354zM24 17.616l-7.502 4.351L9 17.617l7.498 10.378L24 17.616z"/><g fill-rule="nonzero"><path fill-opacity=".298" d="M16.498 4v8.87l7.497 3.35zm0 17.968v6.027L24 17.616z"/><path fill-opacity=".801" d="M16.498 20.573l7.497-4.353-7.497-3.348z"/><path fill-opacity=".298" d="M9 16.22l7.498 4.353v-7.701z"/></g></g></svg>`;
      const USDC_ICON = `<svg width="24" height="24" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><g fill="none"><circle fill="#2775CA" cx="16" cy="16" r="16"/><g fill="#FFF"><path d="M20.022 18.124c0-2.124-1.28-2.852-3.84-3.156-1.828-.243-2.193-.728-2.193-1.578 0-.85.61-1.396 1.828-1.396 1.097 0 1.707.364 2.011 1.275a.458.458 0 00.427.303h.975a.416.416 0 00.427-.425v-.06a3.04 3.04 0 00-2.743-2.489V9.142c0-.243-.183-.425-.487-.486h-.915c-.243 0-.426.182-.487.486v1.396c-1.829.242-2.986 1.456-2.986 2.974 0 2.002 1.218 2.791 3.778 3.095 1.707.303 2.255.668 2.255 1.639 0 .97-.853 1.638-2.011 1.638-1.585 0-2.133-.667-2.316-1.578-.06-.242-.244-.364-.427-.364h-1.036a.416.416 0 00-.426.425v.06c.243 1.518 1.219 2.61 3.23 2.914v1.457c0 .242.183.425.487.485h.915c.243 0 .426-.182.487-.485V21.34c1.829-.303 3.047-1.578 3.047-3.217z"/><path d="M12.892 24.497c-4.754-1.7-7.192-6.98-5.424-11.653.914-2.55 2.925-4.491 5.424-5.402.244-.121.365-.303.365-.607v-.85c0-.242-.121-.424-.365-.485-.061 0-.183 0-.244.06a10.895 10.895 0 00-7.13 13.717c1.096 3.4 3.717 6.01 7.13 7.102.244.121.488 0 .548-.243.061-.06.061-.122.061-.243v-.85c0-.182-.182-.424-.365-.546zm6.46-18.936c-.244-.122-.488 0-.548.242-.061.061-.061.122-.061.243v.85c0 .243.182.485.365.607 4.754 1.7 7.192 6.98 5.424 11.653-.914 2.55-2.925 4.491-5.424 5.402-.244.121-.365.303-.365.607v.85c0 .242.121.424.365.485.061 0 .183 0 .244-.06a10.895 10.895 0 007.13-13.717c-1.096-3.46-3.778-6.07-7.13-7.162z"/></g></g></svg>`;
      const USDT_ICON = `<svg width="24" height="24" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><circle cx="16" cy="16" r="16" fill="#26A17B"/><path fill="#FFF" d="M17.922 17.383v-.002c-.11.008-.677.042-1.942.042-1.01 0-1.721-.03-1.971-.042v.003c-3.888-.171-6.79-.848-6.79-1.658 0-.809 2.902-1.486 6.79-1.66v2.644c.254.018.982.061 1.988.061 1.207 0 1.812-.05 1.925-.06v-2.643c3.88.173 6.775.85 6.775 1.658 0 .81-2.895 1.485-6.775 1.657m0-3.59v-2.366h5.414V7.819H8.595v3.608h5.414v2.365c-4.4.202-7.709 1.074-7.709 2.118 0 1.044 3.309 1.915 7.709 2.118v7.582h3.913v-7.584c4.393-.202 7.694-1.073 7.694-2.116 0-1.043-3.301-1.914-7.694-2.117"/></g></svg>`;
      const CBBTC_ICON = `<svg width="24" height="24" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><circle cx="16" cy="16" r="16" fill="#F7931A"/><path fill="#FFF" fill-rule="nonzero" d="M23.189 14.02c.314-2.096-1.283-3.223-3.465-3.975l.708-2.84-1.728-.43-.69 2.765c-.454-.114-.92-.22-1.385-.326l.695-2.783L15.596 6l-.708 2.839c-.376-.086-.746-.17-1.104-.26l.002-.009-2.384-.595-.46 1.846s1.283.294 1.256.312c.7.175.826.638.805 1.006l-.806 3.235c.048.012.11.03.18.057l-.183-.045-1.13 4.532c-.086.212-.303.531-.793.41.018.025-1.256-.313-1.256-.313l-.858 1.978 2.25.561c.418.105.828.215 1.231.318l-.715 2.872 1.727.43.708-2.84c.472.127.93.245 1.378.357l-.706 2.828 1.728.43.715-2.866c2.948.558 5.164.333 6.097-2.333.752-2.146-.037-3.385-1.588-4.192 1.13-.26 1.98-1.003 2.207-2.538zm-3.95 5.538c-.533 2.147-4.148.986-5.32.695l.95-3.805c1.172.293 4.929.872 4.37 3.11zm.535-5.569c-.487 1.953-3.495.96-4.47.717l.86-3.45c.975.243 4.118.696 3.61 2.733z"/></g></svg>`;
      const WSTETH_ICON = `<svg width="24" height="24" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><g fill="none"><circle fill="#00A3FF" cx="16" cy="16" r="16"/><path d="M9.437 14.864l-.181.275c-2.048 3.097-1.603 7.253 1.034 9.824 1.561 1.521 3.622 2.353 5.683 2.353 0 0 0 0-6.536-12.452z" fill="#FFF"/><path opacity=".6" d="M15.997 18.611l-6.56-3.747c6.56 12.452 6.56 12.452 6.56 12.452 0-2.683 0-5.623 0-8.705z" fill="#FFF"/><path opacity=".6" d="M22.563 14.864l.181.275c2.048 3.097 1.603 7.253-1.034 9.824-1.561 1.521-3.622 2.353-5.683 2.353 0 0 0 0 6.536-12.452z" fill="#FFF"/><path opacity=".2" d="M16.003 18.611l6.56-3.747c-6.56 12.452-6.56 12.452-6.56 12.452 0-2.683 0-5.623 0-8.705z" fill="#FFF"/><path opacity=".2" d="M16.004 10.239v6.459l5.654-3.23-5.654-3.229z" fill="#FFF"/><path opacity=".6" d="M16.005 10.239l-5.655 3.229 5.655 3.23v-6.46z" fill="#FFF"/><path d="M16.005 4.805l-5.655 8.668 5.655-3.233V4.805z" fill="#FFF"/><path opacity=".6" d="M16.004 10.238l5.658 3.23-5.658-8.674v5.444z" fill="#FFF"/></g></svg>`;
      const ZORA_ICON = `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><defs><filter id="blur" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur in="SourceGraphic" stdDeviation="12"/></filter><filter id="mediumBlur" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur in="SourceGraphic" stdDeviation="6"/></filter><filter id="softBlur"><feGaussianBlur in="SourceGraphic" stdDeviation="3"/></filter><radialGradient id="darkBase" cx="60%" cy="60%"><stop offset="0%" style="stop-color:#2C3E50;stop-opacity:1" /><stop offset="40%" style="stop-color:#1A252F;stop-opacity:1" /><stop offset="70%" style="stop-color:#0F1419;stop-opacity:1" /><stop offset="100%" style="stop-color:#000000;stop-opacity:1" /></radialGradient><radialGradient id="cyanGlow" cx="50%" cy="50%"><stop offset="0%" style="stop-color:#00FFFF;stop-opacity:1" /><stop offset="30%" style="stop-color:#00E5E5;stop-opacity:1" /><stop offset="60%" style="stop-color:#00CCCC;stop-opacity:0.8" /><stop offset="100%" style="stop-color:#0099CC;stop-opacity:0" /></radialGradient><radialGradient id="iridescent" cx="50%" cy="50%"><stop offset="0%" style="stop-color:#FFFFFF;stop-opacity:1" /><stop offset="20%" style="stop-color:#FFB3E6;stop-opacity:0.9" /><stop offset="40%" style="stop-color:#E6FFFF;stop-opacity:0.8" /><stop offset="60%" style="stop-color:#B3FFB3;stop-opacity:0.6" /><stop offset="100%" style="stop-color:#66CCFF;stop-opacity:0" /></radialGradient><clipPath id="circleClip"><circle cx="100" cy="100" r="90"/></clipPath></defs><circle cx="100" cy="100" r="90" fill="url(#darkBase)"/><g clip-path="url(#circleClip)"><ellipse cx="65" cy="65" rx="70" ry="75" fill="#0099CC" opacity="0.7" transform="rotate(-30 65 65)" filter="url(#blur)"/><ellipse cx="60" cy="55" rx="55" ry="60" fill="#00CCCC" opacity="0.8" transform="rotate(-25 60 55)" filter="url(#mediumBlur)"/><ellipse cx="55" cy="45" rx="40" ry="45" fill="#00E5E5" opacity="0.9" transform="rotate(-20 55 45)" filter="url(#mediumBlur)"/><ellipse cx="50" cy="40" rx="30" ry="32" fill="#00FFFF" opacity="0.7" transform="rotate(-15 50 40)" filter="url(#softBlur)"/></g><g clip-path="url(#circleClip)"><ellipse cx="48" cy="35" rx="20" ry="18" fill="url(#iridescent)" opacity="0.9" transform="rotate(-10 48 35)"/><ellipse cx="45" cy="32" rx="15" ry="12" fill="#FF66CC" opacity="0.4" filter="url(#softBlur)"/><ellipse cx="43" cy="30" rx="10" ry="8" fill="#FFFFFF" opacity="0.6" filter="url(#softBlur)"/><ellipse cx="50" cy="35" rx="12" ry="10" fill="#CCFF66" opacity="0.2" filter="url(#softBlur)"/></g><g clip-path="url(#circleClip)"><path d="M 90 170 Q 130 150, 160 120 T 180 70 Q 170 100, 150 130 T 90 170" fill="#0F0A05" opacity="0.7" filter="url(#blur)"/><path d="M 20 130 Q 30 160, 60 180 T 100 190 Q 70 180, 40 160 T 20 130" fill="#1A0F0A" opacity="0.6" filter="url(#mediumBlur)"/></g><circle cx="100" cy="100" r="89" fill="none" stroke="#000000" stroke-width="2" opacity="0.5"/></svg>`;
      const DEFAULT_ICON = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="#000" stroke-width="2"/><text x="12" y="16" text-anchor="middle" fill="#000" font-size="12" font-weight="bold">?</text></svg>`;


      function makeLetterIcon(sym) {
        try {
          const full = String(sym ?? "").trim();
          const clean = full.toUpperCase().replace(/[^A-Z0-9]/g, "") || "?";


          // Show up to 5 chars; beyond that, 4 + ellipsis
          const show = clean.length <= 5 ? clean : clean.slice(0, 4) + "…";
          const L = show.length;


          const fontSize =
            L <= 1
              ? 8.2
              : L === 2
              ? 7.4
              : L === 3
              ? 6.3
              : L === 4
              ? 5.4
              : /* L >= 5 */ 4.6;


          // Deterministic hue from symbol
          const hue = [...clean].reduce(
            (a, c) => (a * 31 + c.charCodeAt(0)) % 360,
            0
          );


          // Minimal SVG (no textLength/letter-spacing) to avoid browser quirks
          return (
            `<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-label="${escAttr(
              full
            )}">` +
            `<title>${escText(full)}</title>` +
            `<circle cx="12" cy="12" r="11" fill="hsl(${hue},70%,55%)" stroke="#000" stroke-width="2"/>` +
            `<text x="12" y="12.2" text-anchor="middle" dominant-baseline="middle"` +
            ` font-family="-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif"` +
            ` font-size="${fontSize}" font-weight="700" fill="#fff">${escText(
              show
            )}</text>` +
            `</svg>`
          );
        } catch (e) {
          console.warn("makeLetterIcon fallback:", e);
          return DEFAULT_ICON; // your existing fallback
        }
      }


      function escText(s) {
        return String(s).replace(
          /[&<>]/g,
          (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[m])
        );
      }
      function escAttr(s) {
        return escText(s).replace(/"/g, "&quot;");
      }


      // Helpers
      const fmt = (nStr, max = 6) => {
        const n = Number(nStr);
        if (!isFinite(n)) return "--";
        return n.toLocaleString(undefined, { maximumFractionDigits: max });
      };


      document.addEventListener("DOMContentLoaded", () => {
        updateTokenDisplay();
        document
          .getElementById("fromAmount")
          .addEventListener("input", debounce(handleAmountChange, 400));
      });


      async function connectWallet() {
        try {
          if (!window.ethereum) {
            alert("Please install MetaMask!");
            return;
          }
          provider = new ethers.BrowserProvider(window.ethereum);
          const network = await provider.getNetwork();
          if (Number(network.chainId) !== CHAIN_ID) {
            try {
              await window.ethereum.request({
                method: "wallet_switchEthereumChain",
                params: [{ chainId: "0x2105" }],
              });
            } catch (switchError) {
              if (switchError.code === 4902) {
                await window.ethereum.request({
                  method: "wallet_addEthereumChain",
                  params: [
                    {
                      chainId: "0x2105",
                      chainName: "Base",
                      nativeCurrency: {
                        name: "Ether",
                        symbol: "ETH",
                        decimals: 18,
                      },
                      rpcUrls: ["https://mainnet.base.org"],
                      blockExplorerUrls: ["https://basescan.org"],
                    },
                  ],
                });
              }
            }
          }
          signer = await provider.getSigner();
          account = await signer.getAddress();
          const btn = document.getElementById("connectBtn");
          btn.textContent = account.slice(0, 6) + "..." + account.slice(-4);
          btn.classList.add("connected");
          const swapBtn = document.getElementById("swapBtn");
          swapBtn.textContent = "Enter an amount";
          swapBtn.disabled = true;
          updateBalances();
        } catch (e) {
          console.error("Connection error:", e);
          alert("Failed to connect wallet");
        }
      }


      async function updateBalances() {
        if (!provider || !account) return;
        try {
          const f = tokens[fromToken],
            t = tokens[toToken];
          if (f.address === ZERO_ADDRESS) {
            const bal = await provider.getBalance(account);
            document.getElementById(
              "fromBalance"
            ).textContent = `Balance: ${fmt(ethers.formatEther(bal))} ETH`;
          } else {
            const c = new ethers.Contract(
              f.address,
              ["function balanceOf(address) view returns (uint256)"],
              provider
            );
            const bal = await c.balanceOf(account);
            document.getElementById(
              "fromBalance"
            ).textContent = `Balance: ${fmt(
              ethers.formatUnits(bal, f.decimals)
            )} ${f.symbol}`;
          }
          if (t.address === ZERO_ADDRESS) {
            const bal = await provider.getBalance(account);
            document.getElementById("toBalance").textContent = `Balance: ${fmt(
              ethers.formatEther(bal)
            )} ETH`;
          } else {
            const c = new ethers.Contract(
              t.address,
              ["function balanceOf(address) view returns (uint256)"],
              provider
            );
            const bal = await c.balanceOf(account);
            document.getElementById("toBalance").textContent = `Balance: ${fmt(
              ethers.formatUnits(bal, t.decimals)
            )} ${t.symbol}`;
          }
        } catch (e) {
          console.error("Balance update error:", e);
        }
      }


      const AMM_NAMES = {
        0: "Uniswap V2",
        1: "Aerodrome V1",
        2: "zAMM",
        3: "Uniswap V3",
        4: "Uniswap V4",
        5: "Aerodrome Slipstream",
      };


      async function handleAmountChange() {
        const amt = document.getElementById("fromAmount").value;
        const swapBtn = document.getElementById("swapBtn");
        if (!account) {
          swapBtn.textContent = "Connect Wallet";
          swapBtn.disabled = false;
          return;
        }
        if (!amt || parseFloat(amt) <= 0) {
          document.getElementById("toAmount").value = "";
          document.getElementById("quoteInfo").style.display = "none";
          swapBtn.textContent = "Enter an amount";
          swapBtn.disabled = true;
          return;
        }
        if (fromToken === toToken) {
          document.getElementById("toAmount").value = "";
          document.getElementById("quoteInfo").style.display = "none";
          swapBtn.textContent = "Select different tokens";
          swapBtn.disabled = true;
          return;
        }
        if (!provider) return;


        try {
          swapBtn.innerHTML = `<span class="loading"></span> Getting quote...`;
          swapBtn.disabled = true;
          const quote = await getQuote(amt);
          if (quote) {
            const toData = tokens[toToken];
            document.getElementById("toAmount").value = ethers.formatUnits(
              quote.expectedOutput,
              toData.decimals
            );
            const route = quote.isTwoHop
              ? `${quote.sourceA} + ${quote.sourceB}`
              : `${quote.sourceA}`;
            fitRouteText(route);
            document.getElementById("quoteInfo").style.display = "block";


            // Check allowance if needed
            const fromData = tokens[fromToken];
            if (fromData.address !== ZERO_ADDRESS) {
              const erc20 = new ethers.Contract(
                fromData.address,
                ["function allowance(address,address) view returns (uint256)"],
                provider
              );
              const amountIn = ethers.parseUnits(amt, fromData.decimals);
              const allowance = await erc20.allowance(account, ZROUTER_ADDRESS);
              swapBtn.textContent =
                allowance < amountIn ? "Approve & Swap" : "Swap";
            } else {
              swapBtn.textContent = "Swap";
            }
            swapBtn.disabled = false;
          }
        } catch (e) {
          console.error("Quote error:", e);
          swapBtn.textContent = "Quote failed";
          setTimeout(() => {
            swapBtn.textContent = "Enter an amount";
            swapBtn.disabled = true;
          }, 1500);
        }
      }


      async function setMaxFromBalance() {
        try {
          if (!provider || !account) {
            await connectWallet();
            if (!provider || !account) return;
          }


          const f = tokens[fromToken];
          let raw;


          if (f.address === ZERO_ADDRESS) {
            // Native ETH: use 98% to leave gas buffer
            raw = await provider.getBalance(account);
            raw = (raw * 98n) / 100n; // 98%
            if (raw < 0n) raw = 0n;
          } else {
            // ERC-20: full balance
            const c = new ethers.Contract(
              f.address,
              ["function balanceOf(address) view returns (uint256)"],
              provider
            );
            raw = await c.balanceOf(account);
          }


          // Format, trim trailing zeros, and set input
          const maxStr = ethers.formatUnits(raw, f.decimals);
          const pretty = maxStr.includes(".")
            ? maxStr.replace(/\.?0+$/, "")
            : maxStr;


          const input = document.getElementById("fromAmount");
          input.value = pretty || "0";
          handleAmountChange();
        } catch (e) {
          console.error("MAX error:", e);
        }
      }


      // clamp + read slippage from input; only write back when finalize=true
      const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));
      function readSlippage(finalize = false) {
        const el = document.getElementById("slippagePct");
        if (!el) return;


        const raw = el.value;
        let v = parseFloat(raw);


        if (Number.isFinite(v)) {
          v = clamp(v, 0, 20);
          slippageBps = Math.round(v * 100);
          if (finalize) el.value = String(v);
        } else if (finalize) {
          // if invalid on finalize, snap UI back to current bps (or default 0.5)
          if (!Number.isFinite(slippageBps)) slippageBps = 50;
          el.value = String(clamp(slippageBps / 100, 0, 20));
        }
      }


      // re-quote when user edits slippage (if amount present), debounce a bit
      function initSimpleSlippage() {
        const el = document.getElementById("slippagePct");
        if (!el || el.dataset.inited === "1") return;
        el.dataset.inited = "1";


        readSlippage(false);


        const reQuote = debounce(() => {
          const amt = document.getElementById("fromAmount")?.value;
          if (amt) handleAmountChange();
        }, 250);


        // typing: update internal value but don't overwrite user's text yet
        el.addEventListener("input", () => {
          readSlippage(false);
          reQuote();
        });


        // leaving field: clamp & normalize the text
        el.addEventListener("blur", () => {
          readSlippage(true);
          reQuote();
        });


        // ArrowUp/ArrowDown to step (even with hidden spinners)
        el.addEventListener("keydown", (e) => {
          if (e.key !== "ArrowUp" && e.key !== "ArrowDown") return;
          e.preventDefault();
          const step = parseFloat(el.step || "0.01") || 0.01;
          const digits = (String(step).split(".")[1] || "").length;
          const cur = parseFloat(el.value || "0") || 0;
          const dir = e.key === "ArrowUp" ? 1 : -1;
          const next = clamp(cur + dir * step, 0, 20);
          el.value = next.toFixed(digits);
          readSlippage(true);
          reQuote();
        });
      }
      document.addEventListener("DOMContentLoaded", initSimpleSlippage);


      async function getQuote(fromAmount) {
        if (!account) throw new Error("Connect wallet to get a quote");
        const fromData = tokens[fromToken],
          toData = tokens[toToken];
        if (fromData.address === toData.address) throw new Error("Same token");
        const amountIn = ethers.parseUnits(fromAmount, fromData.decimals);
        readSlippage(true); // sync from input (0–20%)
        const sbps = slippageBps; // bps for quoter
        const deadline = BigInt(Math.floor(Date.now() / 1000) + 300);


        const quoterAbi = [
          "function buildBestSwapViaETHMulticallCompressed(address to,address refundTo,bool exactOut,address tokenIn,address tokenOut,uint256 swapAmount,uint256 slippageBps,uint256 deadline) view returns (tuple(uint8 source,uint256 feeBps,uint256 amountIn,uint256 amountOut) a, tuple(uint8 source,uint256 feeBps,uint256 amountIn,uint256 amountOut) b, bytes[] calls, bytes multicall, bytes multicallCompressed, uint256 msgValue)",
        ];
        const quoter = new ethers.Contract(
          ZQUOTER_ADDRESS,
          quoterAbi,
          provider
        );
        const r = await quoter.buildBestSwapViaETHMulticallCompressed(
          account,
          account,
          false,
          fromData.address,
          toData.address,
          amountIn,
          BigInt(sbps),
          deadline
        );


        const isTwoHop = r.b.amountOut > 0n;
        const expectedOutput = isTwoHop ? r.b.amountOut : r.a.amountOut;
        const sourceA = AMM_NAMES[r.a.source] || "Unknown";
        const sourceB = isTwoHop ? AMM_NAMES[r.b.source] || "Unknown" : null;


        return {
          expectedOutput,
          multicallCompressed: r.multicallCompressed,
          msgValue: r.msgValue ?? 0n,
          isTwoHop,
          sourceA,
          sourceB,
        };
      }


      async function executeSwap() {
        if (!signer || !account) {
          await connectWallet();
          return;
        }


        const amt = document.getElementById("fromAmount").value;
        if (!amt || parseFloat(amt) <= 0) {
          alert("Please enter an amount");
          return;
        }
        if (fromToken === toToken) {
          alert("Select different tokens");
          return;
        }


        const swapBtn = document.getElementById("swapBtn");
        try {
          swapBtn.innerHTML = `<span class="loading"></span> Getting quote...`;
          swapBtn.disabled = true;


          const quote = await getQuote(amt);
          const fromData = tokens[fromToken];
          const amountIn = ethers.parseUnits(amt, fromData.decimals);


          if (fromData.address !== ZERO_ADDRESS) {
            const erc20 = new ethers.Contract(
              fromData.address,
              [
                "function allowance(address,address) view returns (uint256)",
                "function approve(address,uint256) returns (bool)",
              ],
              signer
            );


            swapBtn.textContent = "Checking allowance...";
            const allowance = await erc20.allowance(account, ZROUTER_ADDRESS);
            if (allowance < amountIn) {
              swapBtn.textContent = "Approving token...";
              const approveTx = await erc20.approve(
                ZROUTER_ADDRESS,
                ethers.MaxUint256
              );
              swapBtn.innerHTML = `<a href="https://basescan.org/tx/${approveTx.hash}" target="_blank" style="color:white;text-decoration:none">Approving... (view tx)</a>`;
              const rc = await approveTx.wait();
              if (rc.status === 0)
                throw new Error("Approval transaction failed");
            }
          }


          swapBtn.textContent = "Swapping...";
          // Use ONLY what the quoter says to send.
          // For ETH exact-in this will equal `amountIn`;
          // for ERC-20 it will be 0n; for exact-out it will be the max-in.
          const txValue = quote.msgValue ?? 0n;


          // (optional) sanity guards during dev:
          if (fromData.address === ZERO_ADDRESS && txValue !== amountIn) {
            console.warn("Unexpected: ETH exact-in but msgValue != amountIn", {
              txValue,
              amountIn,
            });
          }
          if (fromData.address !== ZERO_ADDRESS && txValue !== 0n) {
            console.warn("Unexpected: non-zero msgValue for ERC-20 input", {
              txValue,
            });
          }


          const swapTx = await signer.sendTransaction({
            to: ZROUTER_ADDRESS,
            data: quote.multicallCompressed,
            value: txValue,
          });
          swapBtn.innerHTML = `<a href="https://basescan.org/tx/${swapTx.hash}" target="_blank" style="color:white;text-decoration:none">Confirming swap... (view tx)</a>`;
          const receipt = await swapTx.wait();
          if (receipt.status === 0) throw new Error("Swap transaction failed");


          swapBtn.textContent = "✓ Swap Complete!";
          document.getElementById("fromAmount").value = "";
          document.getElementById("toAmount").value = "";
          document.getElementById("quoteInfo").style.display = "none";
          setTimeout(() => {
            updateBalances();
            swapBtn.textContent = "Enter an amount";
            swapBtn.disabled = true;
          }, 1500);
        } catch (e) {
          console.error("Swap error:", e);
          let msg = "Swap failed";
          if (
            e.code === 4001 ||
            (e.message && e.message.toLowerCase().includes("user rejected"))
          )
            msg = "Transaction cancelled";
          else if (
            e.message &&
            e.message.toLowerCase().includes("insufficient funds")
          )
            msg = "Insufficient balance";
          else if (e.reason) msg = e.reason;
          swapBtn.textContent = msg;
          setTimeout(() => {
            swapBtn.textContent = "Swap";
            swapBtn.disabled = false;
          }, 2000);
        }
      }


      function swapTokens() {
        const fAmt = document.getElementById("fromAmount").value;
        const tAmt = document.getElementById("toAmount").value;


        const tmp = fromToken;
        fromToken = toToken;
        toToken = tmp;
        document.getElementById("fromAmount").value = tAmt;
        document.getElementById("toAmount").value = "";
        updateTokenDisplay();
        updateBalances();


        if (fAmt) handleAmountChange();
      }


      function fitRouteText(route) {
        const el = document.getElementById("routeInfo");
        el.textContent = route; // set visible text
        el.title = route; // full value on hover
        el.removeAttribute("data-size");


        // Nudge font size down for especially long routes
        const len = route.length;
        if (len > 48) el.setAttribute("data-size", "xs");
        else if (len > 32) el.setAttribute("data-size", "sm");
      }


      function updateTokenDisplay() {
        const setIcon = (el, sym) => {
          if (sym === "ETH") el.innerHTML = ETH_ICON;
          else if (sym === "USDC") el.innerHTML = USDC_ICON;
          else if (sym === "USDT") el.innerHTML = USDT_ICON;
          else if (sym === "cbBTC") el.innerHTML = CBBTC_ICON;
          else if (sym === "wstETH") el.innerHTML = WSTETH_ICON;
          else if (sym === "ZORA") el.innerHTML = ZORA_ICON;
          else el.innerHTML = makeLetterIcon(sym);
        };
        setIcon(document.getElementById("fromTokenIcon"), fromToken);
        document.getElementById("fromTokenSymbol").textContent =
          tokens[fromToken].symbol;
        setIcon(document.getElementById("toTokenIcon"), toToken);
        document.getElementById("toTokenSymbol").textContent =
          tokens[toToken].symbol;
      }


      function openTokenModal(side) {
        currentModal = side;
        const modal = document.getElementById("tokenModal");
        const list = document.getElementById("tokenList");
        list.innerHTML = "";


        Object.keys(tokens).forEach((symbol) => {
          const row = document.createElement("div");
          row.className = "token-list-item";
          row.onclick = () => selectToken(symbol);


          const iconSpan = document.createElement("span");
          iconSpan.className = "token-icon";
          if (symbol === "ETH") iconSpan.innerHTML = ETH_ICON;
          else if (symbol === "USDC") iconSpan.innerHTML = USDC_ICON;
          else if (symbol === "USDT") iconSpan.innerHTML = USDT_ICON;
          else if (symbol === "cbBTC") iconSpan.innerHTML = CBBTC_ICON;
          else if (symbol === "wstETH") iconSpan.innerHTML = WSTETH_ICON;
          else if (symbol === "ZORA") iconSpan.innerHTML = ZORA_ICON;
          else iconSpan.innerHTML = makeLetterIcon(symbol);


          const nameSpan = document.createElement("span");
          nameSpan.className = "token-symbol";
          nameSpan.textContent = symbol;


          row.appendChild(iconSpan);
          row.appendChild(nameSpan);
          list.appendChild(row);
        });


        modal.style.display = "flex";
      }


      function closeTokenModal() {
        document.getElementById("tokenModal").style.display = "none";
        document.getElementById("customTokenAddress").value = "";
      }


      function selectToken(symbol) {
        if (currentModal === "from") {
          if (symbol === toToken) toToken = fromToken;
          fromToken = symbol;
        } else {
          if (symbol === fromToken) fromToken = toToken;
          toToken = symbol;
        }
        updateTokenDisplay();
        updateBalances();
        closeTokenModal();
        const amt = document.getElementById("fromAmount").value;
        if (amt) handleAmountChange();
      }


      async function addCustomToken() {
        const address = document
          .getElementById("customTokenAddress")
          .value.trim();
        if (!ethers.isAddress(address)) {
          alert("Invalid address");
          return;
        }
        try {
          const rpc =
            provider || new ethers.JsonRpcProvider("https://mainnet.base.org");
          const erc20 = new ethers.Contract(
            address,
            [
              "function symbol() view returns (string)",
              "function decimals() view returns (uint8)",
            ],
            rpc
          );
          const [symbol, decimals] = await Promise.all([
            erc20.symbol(),
            erc20.decimals(),
          ]);
          if (
            tokens[symbol] &&
            tokens[symbol].address.toLowerCase() !== address.toLowerCase()
          ) {
            alert(`A different token with symbol ${symbol} is already listed.`);
            return;
          }
          tokens[symbol] = { address, symbol, decimals };
          selectToken(symbol);
        } catch (e) {
          console.error("Error adding token:", e);
          alert("Failed to add token. Ensure it's a valid ERC20 on Base.");
        }
      }


      function debounce(fn, wait) {
        let t;
        return (...a) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...a), wait);
        };
      }


      // UI events
      document
        .getElementById("connectBtn")
        .addEventListener("click", connectWallet);
      document.getElementById("swapBtn").addEventListener("click", executeSwap);


      // EIP-1193 events (minimal + robust)
      if (window.ethereum) {
        window.ethereum.on("accountsChanged", async (accounts) => {
          if (!accounts || accounts.length === 0) {
            account = null;
            signer = null;
            const btn = document.getElementById("connectBtn");
            btn.textContent = "Connect Wallet";
            btn.classList.remove("connected");
            const sb = document.getElementById("swapBtn");
            sb.textContent = "Connect Wallet";
            sb.disabled = true;
            document.getElementById("fromBalance").textContent = "Balance: --";
            document.getElementById("toBalance").textContent = "Balance: --";
            document.getElementById("quoteInfo").style.display = "none";
            document.getElementById("toAmount").value = "";
            return;
          }
          account = accounts[0];
          if (provider) {
            signer = await provider.getSigner();
            document.getElementById("connectBtn").textContent =
              account.slice(0, 6) + "..." + account.slice(-4);
            document.getElementById("connectBtn").classList.add("connected");
            updateBalances();
          }
        });


        window.ethereum.on("chainChanged", async (chainIdHex) => {
          const id = parseInt(chainIdHex, 16);
          if (id !== CHAIN_ID) {
            try {
              await window.ethereum.request({
                method: "wallet_switchEthereumChain",
                params: [{ chainId: "0x2105" }],
              });
            } catch (err) {
              console.warn("Please switch to Base (8453).", err);
            }
            return;
          }
          if (account) connectWallet();
        });


        window.ethereum.on("disconnect", () =>
          console.log("Provider disconnected")
        );
        window.ethereum.on("connect", (info) =>
          console.log("Provider connected:", info)
        );
      }


      // Auto-reconnect on load
      window.addEventListener("load", async () => {
        if (window.ethereum) {
          try {
            const accts = await window.ethereum.request({
              method: "eth_accounts",
            });
            if (accts && accts.length > 0) connectWallet();
          } catch (e) {
            console.error("Auto-reconnect check failed:", e);
          }
        }
      });


      // No-op cleanup
      window.addEventListener("beforeunload", () => {});
    </script>
  </body>
</html>
